# Why shut down you computer at :
- I don't go to bed at a consistent time for health, productivity, and social reasons
- When I don't go to bed early, chances are I am coding / watching something - so all on my mac
- The system suggestions to 'go to bed' are not dominant enough to make me go to bed, I simply tune them out

## How:
- I will write a program that will schedule to shut down the mac at 12am
- I will distribute it as a brew formula to make it easy to install, bash is not available in Sandboxed apps, so no App Store

## What:
- Install with `brew install hard-sleep`

# TODO:

- Package with Homebrew https://docs.brew.sh/Formula-Cookbook
  - As of Homebrew 4.0.0, formulae are downloaded as JSON from https://formulae.brew.sh which is automatically regenerated by a scheduled Homebrew/formulae.brew.sh job from the master branch of the Homebrew/homebrew-core repository.
  - Homebrew installs formulae to the Cellar at $(brew --cellar) 
  - and then symlinks some of the installation into the prefix at $(brew --prefix) (e.g. /opt/homebrew) so that other programs can see what’s going on. We suggest running brew ls on a few of the kegs in your Cellar to see how it is all arranged.
  - Simple example: https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/e/etl.rb
  - Acceptable Formulae requirements
    - isn’t already in Homebrew (check brew search <formula>)
    - isn’t already waiting to be merged (check the issue tracker)
    - is still supported by upstream (i.e. doesn’t require extensive patching)
    - [todo] has a stable, tagged version (i.e. isn’t just a GitHub repository with no versions)
    - [whuut?] passes all brew audit --new --formula <formula> tests
  - Basically I will need to create a PR to the brew-core github https://docs.brew.sh/How-To-Open-a-Homebrew-Pull-Request
    - How do you make sure it will make the cut?
    - Create a custom tap?
- Post about it
- TELL MY FRIENDS TO TRY IT
- Maybe switch to python? Since it will be installed by brew, I can just set python as a dependency. Its installed everywhere already so does not really matter. Bash is fucking ridiculous. Functions are unlike in any other programming language

# Later:
- Pick a cool name
  - mac-dead-zone
  - kill-my-mac
  - kill-at
- How can I make editing the configuration difficult?
- By allowing to skip the shutdown once by looking at a message to self you wrote when setting this up, and forcing to look at it for 5 minutes before allowing to skip
- Handle when its asleep
  - pmset – manipulate power management settings
  - Looking at last event from `pmset -g log | grep -e " Sleep  " -e " Wake  "` should tell us


# Alternatives:
- Work on the discipline in other ways
- SetApp claims to have multiple solutions https://setapp.com/how-to/shutdown-timer-on-mac:
  - System Settings > Energy Saver - schedule shut down [deprecated]
  - Almighty - many different shortcuts
    - AppStore - unpopular
    - indigoodies ? new distribution channel https://indiegoodies.com/almighty
  - terminal `sudo shutdown -h 60` shut down in an hour.
    - Not great, because it can be stopped by killing the process
    - Actually maybe not such a bad idea. Simply run this command as a detached process
- `pmset repeat shutdown TWRFS 11:00:00`
- `shutdown` command
  - Requires sudo, no idea how to maintain the password without storing it in plaintext, also priving sudo to an app seems like a bad idea
- `osascript` command to run an applescript 
  - `osascript -e 'tell application "System Events" to shut down'`
  - **Picked** because it does not require sudo
  - Suspicious that I can do this without sudo, but tested in the terminal and it worked :D Not complaining.

# Implementation
- Run manually first time
  - Run on startup
  - Run at a certain time - lets start with this: https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingLaunchdJobs.html#//apple_ref/doc/uid/TP40001762-104142
  - **picked** run on a schedule and check time in the script

- How to distribute the shell script to run?
- How to have it be installed by brew into correct location
- How to load the agent?
  - Put in the ~Library/LaunchAgents
  - Use launchctl to load? launchd cannot be started by the user
- How to look at logs?

- When run
- Check what time it is - if it is in the dead zone - play you are in the dead zone https://open.spotify.com/track/7xJ8xGw68KCazVjHC7cEp5?si=377207fb81c0496c
- You fucker have restarted your computer, bonk, go to bed

## Handling sleep 
## pmset -g interesting man page exserpt
INVOKE: pmset -g stats
Sleep Count:1040
Dark Wake Count:1025   -- I assume this is the wake ups due to the launch agents
User Wake Count:30

pmset -g live
System-wide power settings:
Currently in use:
 standby              1
 Sleep On Power Button 1
 hibernatefile        /var/vm/sleepimage
 powernap             1
 networkoversleep     0
 disksleep            10
 sleep                0 (sleep prevented by coreaudiod, useractivityd, powerd, sharingd)
 hibernatemode        3
 ttyskeepawake        1
 displaysleep         0     --- ???
 tcpkeepalive         1
 lowpowermode         0
 womp                 1

-g [?] (with no argument) will display the settings currently in use.
-g live [?] displays the settings currently in use.
-g custom displays custom settings for all power sources.
-g cap displays which power management features the machine supports.
-g sched displays scheduled startup/wake and shutdown/sleep events.
-g ups displays UPS emergency thresholds.
-g ps / batt displays status of batteries and UPSs.
-g pslog displays an ongoing log of power source (battery and UPS) state.
-g rawlog displays an ongoing log of battery state as read directly from battery.
-g therm shows thermal conditions that affect CPU speed. Not available on all platforms.
-g thermlog shows a log of thermal notifications that affect CPU speed. Not available on all platforms.
-g assertions displays a summary of power assertions. Assertions may prevent system sleep or display sleep. Available 10.6 and later.
-g assertionslog shows a log of assertion creations and releases. Available 10.6 and later.
-g sysload displays the "system load advisory" - a summary of system activity available from the IOGetSystemLoadAdvisory API. Available 10.6 and later.
-g sysloadlog displays an ongoing log of lives changes to the system load advisory. Available 10.6 and later.
-g ac / adapter will display details about an attached AC power adapter. Only supported for MacBook and MacBook Pro.
-g log [!] displays a history of sleeps, wakes, and other power management events. This log is for admin & debugging purposes.
-g uuid [?] displays the currently active sleep/wake UUID; used within OS X to correlate sleep/wake activity within one sleep cycle.  history
-g uuidlog [?] displays the currently active sleep/wake UUID, and prints a new UUID as they're set by the system.
-g history [?] is a debugging tool. Prints a timeline of system sleeplwake UUIDs, when enabled with boot-arg io=0x3000000.
-g historydetailed Prints driver-level timings for a sleep/wake. Pass a UUID as an argument.
-g powerstate [?] [class names] Prints the current power states for I/O Kit drivers. Caller may provide one or more I/O Kit class names (separated by spaces) as an argument. If no
classes are provided, it will print all drivers' power states.
-g powerstatelog [-i interval] [class names] Periodically prints the power state residency times for some drivers. Caller may provide one or more I/O Kit class names (separated by
spaces). If no classes are provided, it will log the IOPower plane's root registry entry. Caller may specify a polling interval, in seconds with -i <polling interval>; otherwise it
defaults to 5 seconds.
-g stats Prints the counts for number sleeps and wakes system has gone thru since boot.
-g systemstate Prints the current power state of the system and available capabilites.
-g everything [?] Prints output from every argument under the GETTING header. This is useful for quickly collecting all the output that pmset provides. Available in 10.8.

## Avoid storing state, avoid repeat warnings - I can't figure out this algebra problem
I want:
- To only fire each warning once
- Avoid creating state in the file system with something like "last warning shown XX"
- Allow configurable frequency wnen the script runs (currently hardcoded to a single minute)

I implemented a naive idea of checking proximity to a value, so soft equals with a delta. I have a function that checks if two values are within a delta. There is certainly a relation between the frequency of running the script and what value to pass as the delta.

This also depends on how accurate is the firing time? Every 60 seconds is probably worse than every calendar minute, because the latter should fire on the boundary once the new clock minute elapses. - Not possible, lowest frequency is specifying a minute of the hour, thats once per hour. So every 60 seconds is likely since the launch of the agent. If the agent is started on the 59.98 clock second in the minute (aka the minute is about to flip), the delay between launchd and date in the script returning will result in certain minutes being skipped and neighboring appearing twice.

I can just ignore this problem :D This only matters for the warnings, and I get 2 anyways.

## Shut down hook - prevents shutting down if an app asks to be checked before closing
https://discussions.apple.com/thread/5033645?sortBy=best

Testing if oscript will ignore this. In browser console

```js
// https://developer.mozilla.org/en-US/docs/Web/API/Window/beforeunload_event
addEventListener("beforeunload", (event) => {
    event.preventDefault()
});
```

Solution: `sudo defaults delete com.apple.loginwindow LogoutHook`

